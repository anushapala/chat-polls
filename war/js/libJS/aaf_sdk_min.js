function rawPostMessage(e,t,s){e._source.postMessage(t,e._origin)}function isValidEvent(e,t){return e._origin===t.origin&&e._source===t.source}function messageHandler(e,t){var s=t.data;if(s){if("string"==typeof s)try{s=JSON.parse(t.data)}catch(r){return}var n;if(s.id&&(n=pendingPromises[s.id]))if(s.error){var i=s.error;i.code&&(i=new Error(s.error.msg),i.name=s.error.code,i.stack=s.error.stack),n.reject(i)}else n.resolve(s.result);else if(AAF_EVENT.test(s.key)){var a=s.key.replace(AAF_EVENT,"");e&&e.trigger(a,s.message)}}}var Utils=function(e){var t=function(e){return decodeURIComponent((e||"").replace(/\+/g," "))};return e.queryParameters=function(e){var s,r,n,i,a={};if(e=e||(document.location.search||"").slice(1),0===e.length)return a;s=e.split("&");for(var o=0;o<s.length;o++)r=s[o].split("="),n=t(r[0]),i=t(r[1])||"",a[n]=i;return a},e}({}),PROMISE_TIMEOUT=5e3,AAF_EVENT=/^aaf\./,Promise=window.Promise,version="1.0",pendingPromises={},promiseCount=0,requestCount=0,Client=function(e,t){this._origin=e,this._source=window.parent,this._appId=t,this._messageHandlers={},this._metadata=null,this._context=null,this.ready=!1,this.on("app.registered",function(e){this.ready=!0,this._metadata=e.metadata,this._context=e.context}),this.on("context.updated",function(e){this._context=e},this),this.postMessage("handshake",{version:version}),window.addEventListener("message",messageHandler.bind(null,this))};Client.prototype={postMessage:function(e,t){var s=JSON.stringify({key:"iframe."+e,message:t,appId:this._appId});rawPostMessage(this,s,"iframe.handshake"===e)},on:function(e,t,s){"function"==typeof t&&(this._messageHandlers[e]=this._messageHandlers[e]||[],this._messageHandlers[e].push(s?t.bind(s):t))},off:function(e,t){if(!this._messageHandlers[e])return!1;var s=this._messageHandlers[e].indexOf(t);return this._messageHandlers[e].splice(s,1)[0]},has:function(e,t){return this._messageHandlers[e]?-1!==this._messageHandlers[e].indexOf(t):!1},trigger:function(e,t){return this._messageHandlers[e]?void this._messageHandlers[e].forEach(function(e){e(t)}):!1},request:function(e){var t="request:"+requestCount++,s=Promise.defer();return"string"==typeof e&&(e={url:e}),this.on(t+".done",function(e){s.resolve.apply(this,e.responseArgs)}),this.on(t+".fail",function(e){s.reject.apply(this,e.responseArgs)}),this.postMessage(t,e),s.promise},metadata:function(){var e=Promise.defer();return this._metadata?e.resolve(this._metadata):this.on("app.registered",function(){e.resolve(this._metadata)}.bind(this)),e.promise},context:function(){var e=Promise.defer();return this._context?e.resolve(this._context):this.on("app.registered",function(){e.resolve(this._context)}.bind(this)),e.promise},get:function(e){var t=Array.isArray(e)?e:[e];return wrappedPostMessage.call(this,"get",t)},set:function(e,t){var s=e;return"string"==typeof e&&(s={},s[e]=t),wrappedPostMessage.call(this,"set",s)},invoke:function(){return wrappedPostMessage.bind(this,"invoke").apply(null,arguments)}};var originUrl=function(e){return e.protocol+"//"+e.hostname+(e.port?":"+e.port:"")},AAFClient={};AAFClient.init=function(e){var t,s=Utils.queryParameters();return s.origin="*",t=new Client(s.origin,s.app_guid),"function"==typeof e&&t.on("app.registered",e.bind(t)),t};